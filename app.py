import streamlit as st
from openai import OpenAI

# === App Config (ç¶²ç«™åŸºç¤è¨­å®š) ===
st.set_page_config(page_title="MagicStory Global", page_icon="ğŸ¦„")

# ==========================================
# ğŸ”’ VIP Gate System (å•†æ¥­æ ¸å¿ƒï¼šé–€ç¦ç³»çµ±)
# ==========================================
def check_password():
    """
    æª¢æŸ¥ç”¨æˆ¶è¼¸å…¥çš„å¯†ç¢¼æ˜¯å¦æ­£ç¢ºã€‚
    æ”¯æ´ï¼š
    1. ä»˜è²»å¯†ç¢¼ (å¾ Secrets è®€å–)
    2. è¡ŒéŠ·å…è²»ç¢¼ (REDDIT_FREE, PH_LAUNCH)
    """
    
    # 1. å–å¾—æ‚¨åœ¨é›²ç«¯å¾Œå°è¨­å®šçš„ã€ŒçœŸæ­£ä»˜è²»å¯†ç¢¼ã€
    # å¦‚æœå¾Œå°æ²’è¨­ï¼Œé è¨­å°±æ˜¯ "vip888"
    paid_code = st.secrets.get("ACCESS_CODE", "vip888")
    
    # 2. è¨­å®šã€Œæœ‰æ•ˆå¯†ç¢¼æ¸…å–®ã€ (åŒ…å«ä»˜è²»ç¢¼ + è¡ŒéŠ·ç¢¼)
    valid_codes = [paid_code, "REDDIT_FREE", "PH_LAUNCH"]
    
    # 3. é¡¯ç¤ºè¼¸å…¥æ¡†
    password = st.sidebar.text_input("ğŸ”‘ Access Code (VIP / Promo)", type="password")
    
    # 4. æª¢æŸ¥å¯†ç¢¼
    if password in valid_codes:
        st.sidebar.success("âœ… Access Granted!")
        
        # é¡¯ç¤ºæ­¡è¿è¨Šæ¯ (å€åˆ†æ˜¯ä»˜è²»å¤§çˆºé‚„æ˜¯å…è²»ä»”)
        if password == paid_code:
            st.sidebar.info("Welcome back, VIP Member! ğŸ‘‘")
        else:
            st.sidebar.info("Welcome Reddit/PH User! Enjoy your trial. ğŸš€")
            
        return True
    else:
        # æ²’è¼¸å…¥æˆ–è¼¸å…¥éŒ¯èª¤æ™‚çš„ç•«é¢
        st.warning("ğŸ”’ Content Locked")
        st.info("Please enter your Access Code to unlock.")
        st.markdown("---")
        st.markdown("**Don't have a code?**")
        # é€™è£¡å¯ä»¥æ”¾æ‚¨çš„ Gumroad é€£çµï¼Œå¼•å°ä»–å€‘å»è²·
        st.markdown("[ğŸ‘‰ Get VIP Access Here](https://gumroad.com/l/magicstory-vip)") 
        st.stop() # â›” åœæ­¢ç¨‹å¼ï¼Œä¸è®“çœ‹ä¸‹é¢

# åŸ·è¡Œæª¢æŸ¥
check_password()
# ==========================================


# === Main Interface (English UI for Global Market) ===
st.title("ğŸŒ MagicStory Global")
st.subheader("Create Personalized Audiobooks for Kids")

# === Language Selector (èªè¨€é¸å–®) ===
language = st.selectbox(
    "Select Story Language / é¸æ“‡æ•…äº‹èªè¨€", 
    ["English", "Traditional Chinese (ç¹é«”ä¸­æ–‡)", "Japanese (æ—¥æœ¬èª)", "Spanish (EspaÃ±ol)", "French (FranÃ§ais)"]
)

# === API Key Handling ===
# è‡ªå‹•æŠ“å– Keyï¼Œå¦‚æœæ²’æœ‰å°±è·³å‡ºè¼¸å…¥æ¡†
if "OPENAI_API_KEY" in st.secrets:
    api_key = st.secrets["OPENAI_API_KEY"]
else:
    api_key = st.sidebar.text_input("OpenAI API Key", type="password")

# === User Inputs ===
col1, col2 = st.columns(2)
with col1:
    child_name = st.text_input("Child's Name", "Alex")
    companion = st.text_input("Companion (e.g., Dinosaur)", "Blue Dragon")
with col2:
    mission = st.text_input("Adventure/Mission", "Going to the Moon")
    voice_option = st.selectbox("Voice Style", ["nova (Gentle Female)", "alloy (Neutral)", "echo (Deep Male)", "shimmer (Bright Female)"])

# === Core Logic ===
if st.button("âœ¨ Generate Magic Story", type="primary"):
    if not api_key:
        st.error("Error: API Key not found. Please check your settings.")
    else:
        try:
            client = OpenAI(api_key=api_key)
            
            # 1. Text Generation (GPT-4o)
            with st.spinner(f'Writing story in {language}...'):
                prompt = f"""
                Write a warm, bedtime story for a 5-year-old child.
                Child's Name: {child_name}
                Companion: {companion}
                Adventure: {mission}
                
                Requirements:
                1. Length: Around 350 words.
                2. Language: Write the story ONLY in {language}.
                3. Tone: Fun, engaging, and educational.
                """
                
                response = client.chat.completions.create(
                    model="gpt-4o-mini", messages=[{"role": "user", "content": prompt}]
                )
                story_text = response.choices[0].message.content
            
            st.success("Story created! Generating illustration...")
            st.markdown(f"### ğŸ“– The Adventure of {child_name}")
            st.write(story_text)
            
            # 2. Image Generation (DALL-E 3)
            with st.spinner('Drawing illustration... (This takes about 10s)'):
                img_prompt = f"Children's book illustration, {child_name} and {companion} adventure: {mission}. Style: Pixar animation style, warm lighting, high quality."
                img_response = client.images.generate(
                    model="dall-e-3", prompt=img_prompt, size="1024x1024", quality="standard", n=1
                )
                st.image(img_response.data[0].url, caption=f"Generated by DALL-E 3")

            # 3. Audio Generation (TTS)
            with st.spinner('Recording audio...'):
                voice_code = voice_option.split(" ")[0]
                audio_res = client.audio.speech.create(
                    model="tts-1", voice=voice_code, input=story_text
                )
                st.audio(audio_res.content)
                
        except Exception as e:
            st.error(f"Error: {e}")
